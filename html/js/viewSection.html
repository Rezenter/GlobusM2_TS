<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View section</title>
</head>
<style>
    #timestamp_chart .canvasjs-chart-tooltip,#T_evo_chart .canvasjs-chart-tooltip,#n_evo_chart .canvasjs-chart-tooltip{
        pointer-events: auto !important;
        right: auto !important;
        left: 100% !important;
        top: 0 !important;
        bottom: auto !important;
    }
    #radius_chart .canvasjs-chart-tooltip,
    #T_profile_chart .canvasjs-chart-tooltip, #n_profile_chart .canvasjs-chart-tooltip,
    #fitting_chart .canvasjs-chart-tooltip, #raw_chart .canvasjs-chart-tooltip{
        pointer-events: auto !important;
        right: 100% !important;
        left: auto !important;
        top: 0 !important;
        bottom: auto !important;
    }
    #draggable {
        position: absolute;
        z-index: 9;
        background-color: #f1f1f1;
        border: 1px solid #d3d3d3;
        text-align: center;
    }

    #draggableheader {
        padding: 10px;
        cursor: move;
        z-index: 10;
        background-color: #2196F3;
        color: #fff;
    }
</style>
<body>
    <div id="focus-all" tabindex="0">
        <div class="row" id="db_row" style="
            margin-left: 0;
            margin-right: 0;
            ">
            <label for="is_plasma">Is plasma?</label>
                <input type="checkbox" id="is_plasma" checked>
            <label for="shot_select">Shot №:</label><select id="shot_select"></select>
            <label for="config_select">Configuration:</label><select id="config_select"></select>
            <label for="spectral_select">Spectral calibr.:</label><select id="spectral_select"></select>
            <label for="abs_select">Abs. calibr.:</label><select id="abs_select"></select>
            <button class="btn btn-success glyphicon glyphicon-refresh" id="shot_refresh">Refresh</button>
            <label for="auto_load">Load last shot automatically?</label><input type="checkbox" id="auto_load" checked>
        </div>

        <hr>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                    <div id="timestamp_chart" style="width:100%; height:200px;"></div>
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <div id="radius_chart" style="width:100%; height:200px;"></div>
                </div>
            </div>
        </div>
        <hr>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                    <div id="T_evo_chart" style="width:100%; height:400px;"></div>
                    <div id="n_evo_chart" style="width:100%; height:400px;"></div>
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <div id="T_profile_chart" style="width:100%; height:400px;"></div>
                    <div id="n_profile_chart" style="width:100%; height:400px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="draggable" hidden tabindex="1" style="width: 400px;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div id="draggableheader" tabindex="2">Hold here to move</div>
                </div>
                <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <button class="btn btn-danger" id="hide_draggable">Hide</button>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <label for="poly_input">Poly</label><input id="poly_input" type="number" value="0" min="0" maxlength="1">
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <p id="poly_radius"></p>
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <p id="event_timestamp"></p>
                </div>
            </div>
        </div>

        <div id="fitting_chart" style="width:100%; height:400px;"></div>
        <div id="raw_chart" style="width:100%; height:400px;"></div>

    </div>
</body>
<script>
    function Main () {
        this.m_keypress_timestep = 3;
        this.m_defaults = {
            time_min: 100,
            time_max: 250,
            timestamp_title: ' laser energy',
            radius_title: ' spatial points',
            T_evo_title: ' electron temperature evolution',
            T_prof_title: ' electron temperature profile',
            n_evo_title: ' electron density evolution',
            n_prof_title: ' electron density profile'
        };
        this.m_currentShot = {};
        this.m_current_event_raw = {};
        this.m_current_event_sig = {};
        this.m_expected = {};
        this.m_selected_event_ind = 0;
        this.palette = [
            '#00FFFF',
            '#0000FF',
            '#FF0000',
            '#00FF00',
            '#8A2BE2',
            '#006400',
            '#DC143C',
            '#008b8b',
            '#4B0082',
            '#FF8C00',
            '#ADFF2F',
            '#FF00FF',
            '#808000',
            '#FF4500',
            '#FFFF00',
        ];
        this.m_current_channels = [
            true,
            true,
            true,
            true,
            true,
            true,
            true
        ];

        this.m_timestamp_chart = new CanvasJS.StockChart("timestamp_chart",{
            theme: "light2",
            charts: [{
                title: {
                    text: "Shot timeline",
                    fontFamily: 'arial'
                },
                axisY: {
                    includeZero: true,
                    title: "Energy, mV*ns",
                    fontFamily: 'arial'
                },
                axisX: {
                    title: "Timestamp, ms",
                    fontFamily: 'arial',
                    crosshair: {
                        enabled: true,
                        snapToDataPoint: true,
                        labelFormatter: function(e) {
                            return e.value.toFixed(1);
                        },
                        updated: function(e){
                            this.m_T_evo_chart.axisX[0].crosshair.showAt(e.value);
                            this.m_n_evo_chart.axisX[0].crosshair.showAt(e.value);
                        }.bind(this),
                        hidden: function (e){
                            this.m_n_evo_chart.axisX[0].crosshair.showAt(e.value);
                            this.m_T_evo_chart.axisX[0].crosshair.hide();
                        }.bind(this)
                    }
                },
                toolTip: {
                    contentFormatter: function(e){
                        return ('time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms, E = ' +
                            e.entries[0].dataPoint.y.toFixed(2) + 'mV*ns');
                    },
                    updated: function(e){
                        this.m_T_evo_chart.toolTip.showAtX(e.entries[0].xValue);
                        this.m_n_evo_chart.toolTip.showAtX(e.entries[0].xValue);
                    }.bind(this),
                    hidden: function(e){
                        this.m_T_evo_chart.toolTip.hide();
                        this.m_n_evo_chart.toolTip.hide();
                    }.bind(this)
                },
                data: []
            }],
            navigator: {
                data: [{
                    type: 'column',
                    color: "#B0D0B0",
                    dataPoints: []
                }],
                slider: {
                    minimum: this.m_defaults.time_min,
                    maximum: this.m_defaults.time_max,
                    height: 100
                }
            },
            rangeChanged: function(e){
                this.RangeChanged(e);
            }.bind(this),
        });

        this.m_radius_chart = new CanvasJS.Chart("radius_chart", {
            title: {
                text: "Spatial points",
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                title: "Z, cm",
                fontFamily: 'arial',
                titleFontSize: 12,
                includeZero: true,
                minimum: -10,
                maximum: 10
            },
            axisX: {
                title: "R, mm",
                titleFontSize: 12,
                interval: 20,
                fontFamily: 'arial'
            },
            data: []
        });
        this.m_radius_chart.render();

        this.m_T_evo_chart = new CanvasJS.Chart("T_evo_chart", {
            title: {
                text: 'Electron temperature evolution',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron temperature, eV',
                titleFontSize: 12,
                minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "Time, ms",
                titleFontSize: 12,
                minimum: 100,
                maximum: 250,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function(e) {
                        return e.value.toFixed(1);
                    },
                    updated: function(e){
                        this.m_n_evo_chart.axisX[0].crosshair.showAt(e.value);
                        this.m_timestamp_chart.charts[0].axisX[0].crosshair.showAt(e.value);
                    }.bind(this),
                    hidden: function (e){
                        this.m_n_evo_chart.axisX[0].crosshair.hide();
                        this.m_timestamp_chart.charts[0].axisX[0].crosshair.hide();
                    }.bind(this)
                },
                fontFamily: 'arial'
            },
            toolTip: {
                //backgroundColor: "rgba(255,255,255,.2)",
                shared: true,
                contentFormatter: function(e){
                    let text = '<p>time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms</p>';
                    for(let entry of e.entries){
                        if(typeof entry.dataPoint.y == 'number'){
                            text += '<p style="color:' + entry.dataSeries.color + ';">' + entry.dataSeries.options.name + ', T<sub>e</sub> = ' + entry.dataPoint.y.toFixed(1);
                        }else{
                            text += '±' + ((entry.dataPoint.y[1] - entry.dataPoint.y[0])*0.5).toFixed(1) + ' eV</p>'
                        }
                    }
                    return text;
                }.bind(this),
                updated: function(e){
                    this.m_n_evo_chart.toolTip.showAtX(e.entries[0].xValue);
                    this.m_timestamp_chart.charts[0].toolTip.showAtX(e.entries[0].xValue);
                }.bind(this),
                hidden: function(e){
                    this.m_n_evo_chart.toolTip.hide();
                    this.m_timestamp_chart.charts[0].toolTip.hide();
                }.bind(this)
            },
            legend: {
                cursor: "pointer",
                itemmouseover: function(e) {
                    if(e.dataSeries.visible) {
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_T_evo_chart.data[e.dataSeriesIndex].lineThickness * 2;
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_T_evo_chart.data[e.dataSeriesIndex + 1].lineThickness * 2;
                        this.m_T_evo_chart.render();
                        this.m_n_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_n_evo_chart.data[e.dataSeriesIndex].lineThickness * 2;
                        this.m_n_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_n_evo_chart.data[e.dataSeriesIndex + 1].lineThickness * 2;
                        this.m_n_evo_chart.render();
                    }
                }.bind(this),
                itemmouseout: function(e) {
                    if(e.dataSeries.visible) {
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_T_evo_chart.data[e.dataSeriesIndex].lineThickness * 0.5;
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_T_evo_chart.data[e.dataSeriesIndex + 1].lineThickness * 0.5;
                        this.m_T_evo_chart.render();
                        this.m_n_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_n_evo_chart.data[e.dataSeriesIndex].lineThickness * 0.5;
                        this.m_n_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_n_evo_chart.data[e.dataSeriesIndex + 1].lineThickness * 0.5;
                        this.m_n_evo_chart.render();
                    }
                }.bind(this),
                itemclick: function (e) {
                    e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                    this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].visible = e.dataSeries.visible;
                    this.m_T_evo_chart.render();

                    this.m_n_evo_chart.options.data[e.dataSeriesIndex].visible = e.dataSeries.visible;
                    this.m_n_evo_chart.options.data[e.dataSeriesIndex + 1].visible = e.dataSeries.visible;
                    this.m_n_evo_chart.render();
                }.bind(this)
            },
            data: []
        });
        this.m_T_evo_chart.render();
        this.m_n_evo_chart = new CanvasJS.Chart("n_evo_chart", {
            title: {
                text: 'Electron density evolution',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron density, m⁻³',
                titleFontSize: 12,
                labelFormatter: function ( e ) {
                    return e.value.toExponential(1);
                },
                minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "Time, ms",
                titleFontSize: 12,
                minimum: 100,
                maximum: 250,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function(e) {
                        return e.value.toFixed(1);
                    },
                    updated: function(e){
                        this.m_T_evo_chart.axisX[0].crosshair.showAt(e.value);
                        this.m_timestamp_chart.charts[0].axisX[0].crosshair.showAt(e.value);
                    }.bind(this),
                    hidden: function (e){
                        this.m_T_evo_chart.axisX[0].crosshair.hide();
                        this.m_timestamp_chart.charts[0].axisX[0].crosshair.hide();
                    }.bind(this)
                },
                fontFamily: 'arial'
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    let text = '<p>time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms</p>';
                    for(let entry of e.entries){
                        if(typeof entry.dataPoint.y == 'number'){
                            text += '<p style="color:' + entry.dataSeries.color + ';">' + entry.dataSeries.options.name + ', n<sub>e</sub> = ' + entry.dataPoint.y.toExponential(1);
                        }else{
                            text += '±' + ((entry.dataPoint.y[1] - entry.dataPoint.y[0])*0.5).toExponential(1) + ' m<sup>-3</sup></p>'
                        }
                    }
                    return text;
                },
                updated: function(e){
                    this.m_T_evo_chart.toolTip.showAtX(e.entries[0].xValue);
                    this.m_timestamp_chart.charts[0].toolTip.showAtX(e.entries[0].xValue);
                }.bind(this),
                hidden: function(e){
                    this.m_T_evo_chart.toolTip.hide();
                    this.m_timestamp_chart.charts[0].toolTip.hide();
                }.bind(this)
            },
            data: []
        });
        this.m_n_evo_chart.render();

        this.m_T_profile_data = [];
        this.m_T_profile_chart = new CanvasJS.Chart("T_profile_chart", {
            title: {
                text: 'Electron temperature profile',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron temperature, eV',
                titleFontSize: 12,
                minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "R, mm",
                titleFontSize: 12,
                minimum: 350,
                maximum: 570,
                interval: 20,
                fontFamily: 'arial'
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    return ('R = ' + e.entries[0].dataPoint.x.toFixed(0) + 'mm ');
                },
            },
            data: this.m_T_profile_data
        });
        this.m_T_profile_chart.render();
        this.m_n_profile_data = [];
        this.m_n_profile_chart = new CanvasJS.Chart("n_profile_chart", {
            title: {
                text: 'Electron density profile',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron density, m⁻³',
                titleFontSize: 12,
                minimum: 0,
                labelFormatter: function ( e ) {
                    return e.value.toExponential(1);
                },
                fontFamily: 'arial'
            },
            axisX: {
                title: "R, mm",
                titleFontSize: 12,
                minimum: 350,
                maximum: 570,
                interval: 20,
                fontFamily: 'arial'
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    return ('R = ' + e.entries[0].dataPoint.x.toFixed(0) + 'mm');
                },
            },
            data: this.m_n_profile_data
        });
        this.m_n_profile_chart.render();

        this.m_fitting_chart = new CanvasJS.Chart("fitting_chart", {
            zoomEnabled: true,
            title: {
                text: 'Spectrum fitting',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Signal, a.u.',
                titleFontSize: 12,
                minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "Electron temperature, eV",
                titleFontSize: 12,
                minimum: 0,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function(e) {
                        return e.value.toFixed(1);
                    }
                },
                fontFamily: 'arial'
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    let poly_ind = $('#poly_input').val();
                    let text = '<p>T = ' + this.m_currentShot.events[this.m_selected_event_ind].T_e[poly_ind].T.toFixed(1) + 'eV</p>' +
                        '<p>𝜒<sup>2</sup> = ' + this.m_currentShot.events[this.m_selected_event_ind].T_e[poly_ind].chi2.toFixed(3) + '</p>';
                    for(let ch = 0; ch < this.m_expected.poly[poly_ind].expected.length; ch++){
                        text += '<p style="color:' + this.palette[ch] + ';">' +
                            'ch ' + (ch + 1) + ', S = ' +
                            (this.m_current_event_sig.poly[poly_ind].ch[ch].ph_el / this.m_currentShot.events[this.m_selected_event_ind].T_e[poly_ind].mult).toFixed(3) +
                            '±' + ((this.m_current_event_sig.poly[poly_ind].ch[ch].err) / this.m_currentShot.events[this.m_selected_event_ind].T_e[poly_ind].mult).toFixed(3) + ' a.u.</p>'
                    }
                    return text;
                }.bind(this),
            },
            legend: {
                cursor: "pointer",
                itemmouseover: function(e) {
                    if(e.dataSeries.visible) {
                        // fuck up
                        let dt = 1 / parseFloat(this.m_currentShot.header.frequency);
                        let poly_ind = $('#poly_input').val();
                        let series_index = 0;
                        let ch = 0;
                        for(;ch < this.m_expected.poly[poly_ind].expected.length; ch++){
                            if(series_index === e.dataSeriesIndex){
                                break;
                            }
                            if(this.m_current_event_sig.poly[poly_ind].ch[ch].processed_bad) {
                                series_index += 1;
                            }else{
                                series_index += 3;
                            }
                        }
                        this.m_fitting_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_fitting_chart.data[e.dataSeriesIndex].lineThickness * 2;
                        this.m_fitting_chart.render();

                        this.m_raw_chart.options.data[ch].lineThickness = this.m_raw_chart.data[ch].lineThickness * 2;
                        this.m_raw_chart.options.axisX.stripLines = [{
                            startValue: (this.m_current_event_sig.poly[$('#poly_input').val()].ch[ch].from - this.m_current_event_raw.start) * dt,
                            endValue: (this.m_current_event_sig.poly[$('#poly_input').val()].ch[ch].to - this.m_current_event_raw.start) * dt,
                            color: this.palette[ch],
                            opacity: .2
                        }];
                        this.m_raw_chart.render();

                    }
                }.bind(this),
                itemmouseout: function(e) {
                    if(e.dataSeries.visible) {
                        let poly_ind = $('#poly_input').val();
                        let series_index = 0;
                        let ch = 0;
                        for(;ch < this.m_expected.poly[poly_ind].expected.length; ch++){
                            if(series_index === e.dataSeriesIndex){
                                break;
                            }
                            if(this.m_current_event_sig.poly[poly_ind].ch[ch].processed_bad) {
                                series_index += 1;
                            }else{
                                series_index += 3;
                            }
                        }
                        this.m_fitting_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_fitting_chart.data[e.dataSeriesIndex].lineThickness * 0.5;
                        this.m_fitting_chart.render();

                        this.m_raw_chart.options.data[ch].lineThickness = this.m_raw_chart.data[ch].lineThickness * 0.5;
                        this.m_raw_chart.options.axisX.stripLines = [];
                        this.m_raw_chart.render();
                    }
                }.bind(this),
                itemclick: function (e) {
                    e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                    let poly_ind = $('#poly_input').val();
                    let series_index = 0;
                    let ch = 0;
                    for(;ch < this.m_expected.poly[poly_ind].expected.length; ch++){
                        if(series_index === e.dataSeriesIndex){
                            break;
                        }
                        if(this.m_current_event_sig.poly[poly_ind].ch[ch].processed_bad) {
                            series_index += 1;
                        }else{
                            series_index += 3;
                        }
                    }
                    this.m_current_channels[ch] = e.dataSeries.visible;
                    this.m_fitting_chart.options.data[e.dataSeriesIndex].visible = e.dataSeries.visible;
                    if(!this.m_current_event_sig.poly[poly_ind].ch[ch].processed_bad) {
                        this.m_fitting_chart.options.data[e.dataSeriesIndex + 1].visible = e.dataSeries.visible;
                        this.m_fitting_chart.options.data[e.dataSeriesIndex + 2].visible = e.dataSeries.visible;
                    }
                    this.m_fitting_chart.render();

                    this.m_raw_chart.options.data[ch].visible = e.dataSeries.visible;
                    this.m_raw_chart.options.axisX.stripLines = [];
                    this.m_raw_chart.render();
                }.bind(this)
            },
            data: []
        });
        this.m_fitting_chart.render();
        this.m_raw_chart = new CanvasJS.Chart("raw_chart", {
            zoomEnabled: true,
            title: {
                text: 'Raw signals',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Signal, mv',
                titleFontSize: 12,
                //minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "time, ns",
                titleFontSize: 12,
                minimum: 0,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function(e) {
                        return e.value.toFixed(1);
                    }
                },
                fontFamily: 'arial',
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    let poly_ind = $('#poly_input').val();
                    let text = '<p>t = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ns</p>';
                    text += '<p>cell = ' + e.entries[0].index + '</p>';
                    let ch = 0;
                    for(; ch < this.m_current_event_raw.data.length; ch++){
                        if(this.m_current_channels[ch]) {
                            text += '<p style="color:' + this.palette[ch] + ';">' +
                                'ch ' + (ch + 1) + ', U = ' + e.entries[ch].dataPoint.y.toFixed(1) + ' mV,';
                            if ('pre_std' in this.m_current_event_sig.poly[poly_ind].ch[ch]) {
                                text += 'std = ' + this.m_current_event_sig.poly[poly_ind].ch[ch].pre_std.toFixed(1) + ' mV' +
                                    '<p style="color:' + this.palette[ch] + ';">' +
                                    'int. = ' + this.m_current_event_sig.poly[poly_ind].ch[ch].int.toFixed(1) + ' mV*ns</p>' +
                                    '<p style="color:' + this.palette[ch] + ';">S = ' +
                                    this.m_current_event_sig.poly[poly_ind].ch[ch].ph_el.toFixed(1) + '±' +
                                    this.m_current_event_sig.poly[poly_ind].ch[ch].err.toFixed(1) + ' ph.el.</p>';
                            }
                            text += '</p>';
                        }

                    }
                    if(this.m_current_channels[ch]) {
                        text += '<p style="color:#B0D0B0;">' +
                            'laser ' + ', U = ' + e.entries[ch].dataPoint.y.toFixed(1) + ' mV,' +
                            'std = ' + this.m_current_event_sig.laser.ave.pre_std.toFixed(1) + ' mV</p>' +
                            '<p style="color:#B0D0B0;">' +
                            'int = ' + this.m_current_event_sig.laser.ave.int.toFixed(1) + ' mV*ns</p>';
                    }
                    return text;
                }.bind(this),
            },
            legend: {
                cursor: "pointer",
                itemmouseover: function(e) {
                    if(e.dataSeries.visible) {
                        let dt = 1 / parseFloat(this.m_currentShot.header.frequency);
                        this.m_raw_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_raw_chart.data[e.dataSeriesIndex].lineThickness * 2;
                        if(e.dataSeriesIndex !== 5) {
                            this.m_raw_chart.options.axisX.stripLines = [{
                                startValue: 0,
                                endValue: (this.m_current_event_sig.laser.ave.int_len) * dt,
                                color: "#B0D0B0",
                                opacity: .2
                            }];
                        }

                        this.m_raw_chart.render();
                    }
                }.bind(this),
                itemmouseout: function(e) {
                    if(e.dataSeries.visible) {
                        this.m_raw_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_raw_chart.data[e.dataSeriesIndex].lineThickness * 0.5;
                        this.m_raw_chart.options.axisX.stripLines = [];
                        this.m_raw_chart.render();
                    }
                }.bind(this),
                itemclick: function (e) {
                    this.m_current_channels[e.dataSeriesIndex] = (!(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible));
                    this.m_raw_chart.options.data[e.dataSeriesIndex].visible = this.m_current_channels[e.dataSeriesIndex];
                    //this.m_raw_chart.options.data[e.dataSeriesIndex / 2].lineThickness = this.m_raw_chart.data[e.dataSeriesIndex / 2].lineThickness * 0.5;
                    this.m_raw_chart.options.axisX.stripLines = [];
                    this.m_raw_chart.render();
                }.bind(this)
            },
            data: []
        });
        this.m_raw_chart.render();

        this.RangeChanged = function(e){
            this.m_T_evo_chart.options.axisX.minimum = e.minimum;
            this.m_T_evo_chart.options.axisX.maximum = e.maximum;
            this.m_T_evo_chart.render();
            this.m_n_evo_chart.options.axisX.minimum = e.minimum;
            this.m_n_evo_chart.options.axisX.maximum = e.maximum;
            this.m_n_evo_chart.render();
            this.UpdateProfiles({'data': this});
        };

        this.Request = function (req, callback) {
            req.subsystem = 'view';
            $.post('/api', JSON.stringify(req), function(resp){
                if(!resp['ok']){
                    //console.log(resp);
                    alert(resp['description']);
                }else {
                    callback(resp);
                }
            }, 'json');
        };


        this.Refresh = function(ev) {
            let self = ev.data;
            self.Request(
                {
                    reqtype: 'refresh'
                }
                , function (resp) {
                    self.m_plasma_shots = resp['plasma'];
                    self.m_debug_shots = resp['debug'];
                    self.UpdateShotSelect({data: self});
                }
            );
        };

        this.UpdateShotSelect = function(ev) {
            let self = ev.data;
            let shots = self.m_plasma_shots;
            if(! $('#is_plasma')[0].checked){
                shots = self.m_debug_shots;
            }
            let options = [];
            shots.forEach(shot => options.push("<option>" + shot + "</option>"));
            $('#shot_select').html(options);

            options = ['<option>2020.12.10</option>'];
            $('#config_select').html(options);

            options = ['<option>2020.11.06</option>'];
            $('#abs_select').html(options);

            options = ['<option>2020.11.11</option>'];
            $('#spectral_select').html(options);

            if(options.length && $('#auto_load')[0].checked){
                self.Select({data: self});
            }
        };

        this.Select = function(ev){
            let self = ev.data;
            self.Request(
                {
                    reqtype: 'get_shot',
                    is_plasma: $('#is_plasma')[0].checked,
                    shotn: $('#shot_select').val(),
                    config: $('#config_select').val()
                }, function (resp) {
                    //console.log(resp);
                    Object.assign(self.m_currentShot, resp);
                    $('#poly_input').attr('max', self.m_currentShot.polys.length - 1);
                    $('#time_input').attr('max', self.m_currentShot.polys.length - 1);
                    self.m_timestamp_chart.options.charts[0].data = [{
                        color: "#B0D0B0",
                        type: "column",
                        showInLegend: false,
                        name: 'Laser energy',
                        dataPoints: [],
                        click: self.ShowEvent.bind(self)
                    }];

                    self.m_T_evo_chart.options.data = [];
                    self.m_n_evo_chart.options.data = [];
                    self.m_radius_chart.options.data = [];
                    self.m_T_profile_data = [];
                    self.m_n_profile_data = [];

                    self.m_timestamp_chart.options.charts[0].title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.timestamp_title;
                    self.m_radius_chart.options.title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.radius_title;
                    self.m_T_evo_chart.options.title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.T_evo_title;
                    self.m_T_profile_chart.options.title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.T_prof_title;
                    self.m_n_evo_chart.options.title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.n_evo_title;
                    self.m_n_profile_chart.options.title.text = 'Globus-M2 #' +
                        $('#shot_select').val() + self.m_defaults.n_prof_title;
                    //console.log(resp);
                    for(let poly_ind = 0; poly_ind < resp.polys.length; poly_ind++){
                        let h05 = resp.polys[poly_ind].h * 0.5;
                        self.m_radius_chart.options.data.push(
                            {
                                type: "rangeArea",
                                markerType: "none",
                                color: self.palette[poly_ind],
                                showInLegend: true,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                dataPoints: [{
                                    x: resp.polys[poly_ind].R - resp.polys[poly_ind].l05,
                                    y: [-h05, h05]
                                },
                                    {
                                        x: resp.polys[poly_ind].R + resp.polys[poly_ind].l05,
                                        y: [-h05, h05]
                                    }]
                            }
                        );

                        self.m_T_evo_chart.options.data.push(
                            {
                                type: "line",
                                color: self.palette[poly_ind],
                                visible: true,
                                markerType: "none",
                                showInLegend: true,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                connectNullData: true,
                                nullDataLineDashType:  "dot",
                                dataPoints: [],
                                click: self.ShowEvent.bind(self)
                            }
                        );
                        self.m_T_evo_chart.options.data.push(
                            {
                                type: "error",
                                color: self.palette[poly_ind],
                                visible: true,
                                showInLegend: false,
                                dataPoints: [],
                                //click: self.ShowEvent.bind(self)
                            }
                        );

                        self.m_n_evo_chart.options.data.push(
                            {
                                type: "line",
                                color: self.palette[poly_ind],
                                visible: true,
                                markerType: "none",
                                showInLegend: false,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                connectNullData: true,
                                nullDataLineDashType:  "dot",
                                dataPoints: [],
                                click: self.ShowEvent.bind(self)
                            }
                        );
                        self.m_n_evo_chart.options.data.push(
                            {
                                type: "error",
                                color: self.palette[poly_ind],
                                visible: true,
                                showInLegend: false,
                                dataPoints: [],
                                //click: self.ShowEvent.bind(self)
                            }
                        );
                    }
                    self.m_radius_chart.render();

                    //console.log(resp);
                    for(let event_ind = 0; event_ind < resp.events.length; event_ind++){
                        if(resp.events[event_ind].processed_bad){
                            self.m_timestamp_chart.options.charts[0].data[0].dataPoints.push(
                                {
                                    x: resp.events[event_ind].timestamp,
                                    y: null
                                }
                            );
                        }else {
                            self.m_timestamp_chart.options.charts[0].data[0].dataPoints.push(
                                {
                                    x: resp.events[event_ind].timestamp,
                                    y: resp.events[event_ind].energy
                                }
                            );
                        }

                        self.m_T_profile_data.push({
                            //color: "#B0D0B0",
                            type: "line",
                            showInLegend: false,
                            name: 'time = ' + resp.events[event_ind].timestamp,
                            connectNullData: true,
                            nullDataLineDashType:  "dot",
                            dataPoints: [],
                            click: function (e) {
                                console.log(e);
                            }
                        });
                        self.m_T_profile_data.push(
                            {
                                //color: "#B0D0B0",
                                type: "error",
                                showInLegend: false,
                                dataPoints: []
                            }
                        );

                        self.m_n_profile_data.push({
                            //color: "#B0D0B0",
                            type: "line",
                            showInLegend: false,
                            name: 'time = ' + resp.events[event_ind].timestamp,
                            connectNullData: true,
                            nullDataLineDashType:  "dot",
                            dataPoints: [],
                            click: function (e) {
                                console.log(e);
                            }
                        });
                        self.m_n_profile_data.push(
                            {
                                //color: "#B0D0B0",
                                type: "error",
                                showInLegend: false,
                                dataPoints: []
                            }
                        );

                        for(let poly_ind = 0; poly_ind < resp.polys.length; poly_ind++) {
                            if(resp.events[event_ind].T_e[poly_ind].processed_bad){
                                self.m_T_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: null
                                    }
                                );
                                self.m_n_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: null
                                    }
                                );
                            }else {
                                self.m_T_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: resp.events[event_ind].T_e[poly_ind].T
                                    }
                                );
                                self.m_T_evo_chart.options.data[poly_ind * 2 + 1].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: [resp.events[event_ind].T_e[poly_ind].T - resp.events[event_ind].T_e[poly_ind].Terr,
                                            resp.events[event_ind].T_e[poly_ind].T + resp.events[event_ind].T_e[poly_ind].Terr]
                                    }
                                );


                                self.m_n_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: resp.events[event_ind].T_e[poly_ind].n
                                    }
                                );
                                self.m_n_evo_chart.options.data[poly_ind * 2 + 1].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: [resp.events[event_ind].T_e[poly_ind].n - resp.events[event_ind].T_e[poly_ind].n_err,
                                            resp.events[event_ind].T_e[poly_ind].n + resp.events[event_ind].T_e[poly_ind].n_err]
                                    }
                                );

                                self.m_T_profile_data[self.m_T_profile_data.length - 2].dataPoints.push(
                                    {
                                        x: resp.polys[poly_ind].R,
                                        y: resp.events[event_ind].T_e[poly_ind].T
                                    }
                                );
                                self.m_T_profile_data[self.m_T_profile_data.length - 1].dataPoints.push(
                                    {
                                        x: resp.polys[poly_ind].R,
                                        y: [resp.events[event_ind].T_e[poly_ind].T - resp.events[event_ind].T_e[poly_ind].Terr,
                                            resp.events[event_ind].T_e[poly_ind].T + resp.events[event_ind].T_e[poly_ind].Terr]
                                    }
                                );
                                self.m_n_profile_data[self.m_n_profile_data.length - 2].dataPoints.push(
                                    {
                                        x: resp.polys[poly_ind].R,
                                        y: resp.events[event_ind].T_e[poly_ind].n
                                    }
                                );
                                self.m_n_profile_data[self.m_n_profile_data.length - 1].dataPoints.push(
                                    {
                                        x: resp.polys[poly_ind].R,
                                        y: [resp.events[event_ind].T_e[poly_ind].n - resp.events[event_ind].T_e[poly_ind].n_err,
                                            resp.events[event_ind].T_e[poly_ind].n + resp.events[event_ind].T_e[poly_ind].n_err]
                                    }
                                );
                            }
                        }
                    }
                    self.m_timestamp_chart.options.navigator.data[0].dataPoints =
                        self.m_timestamp_chart.options.charts[0].data[0].dataPoints;
                    self.m_timestamp_chart.render();
                    self.m_T_evo_chart.render();
                    self.m_n_evo_chart.render();

                    self.m_timestamp_chart.navigator.slider.set("maximum", self.m_defaults.time_max);
                    self.m_timestamp_chart.navigator.slider.set("minimum", self.m_defaults.time_min);
                    self.RangeChanged({
                        minimum: self.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: self.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                }
            );
        };

        this.ShowEvent = function (ev){
            //console.log('showing', ev);
            this.m_selected_event_ind = ev.dataPointIndex;
            this.update_fit({data: this})
            $('#draggable')[0].removeAttribute('hidden');
        };

        this.update_fit = function (ev){
            let self = ev.data;
            if(jQuery.isEmptyObject(self.m_expected) || self.m_expected.name === self.m_currentShot.spectral_name){
                self.Request(
                    {
                        reqtype: 'get_expected'
                    }
                    , function (resp) {
                        Object.assign(self.m_expected, resp);
                        self.m_expected['name'] = self.m_currentShot.spectral_name;
                        self.draw_popup(ev);
                    }
                );
            }else{
                self.draw_popup({data: self});
            }
        };

        this.draw_popup = function(ev){
            let self = ev.data;
            let poly_ind = $('#poly_input').val();

            $('#event_timestamp').html(self.m_currentShot.events[self.m_selected_event_ind].timestamp.toFixed(2) + ' ms');
            $('#poly_radius').html(self.m_currentShot.polys[poly_ind].R + ' mm');
            self.m_fitting_chart.options.data = [];
            self.m_current_event_sig = {};
            self.Request(
                {
                    reqtype: 'get_event_sig',
                    event: self.m_selected_event_ind,
                    is_plasma: $('#is_plasma')[0].checked,
                    shotn: $('#shot_select').val()
                }
                , function (resp) {
                    Object.assign(self.m_current_event_sig, resp);
                    //console.log(self.m_current_event_sig);
                    for(let ch = 0; ch < self.m_expected.poly[poly_ind].expected.length; ch++){
                        let data = [];
                        for(let temp_ind = 0; temp_ind < self.m_expected.T_arr.length; temp_ind++){
                            data.push(
                                {
                                    x: self.m_expected.T_arr[temp_ind],
                                    y: self.m_expected.poly[poly_ind].expected[ch][temp_ind]
                                });
                        }
                        self.m_fitting_chart.options.data.push({
                            type: "line",
                            visible: self.m_current_channels[ch],
                            markerType: "none",
                            color: self.palette[ch],
                            showInLegend: true,
                            name: 'ch ' + (ch + 1),
                            dataPoints: data
                        });
                        if(!resp.poly[poly_ind].ch[ch].processed_bad) {
                            self.m_fitting_chart.options.data.push({
                                type: "scatter",
                                visible: self.m_current_channels[ch],
                                color: self.palette[ch],
                                showInLegend: false,
                                name: 'measured ' + (ch + 1),
                                dataPoints: [{
                                    x: self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].T,
                                    y: resp.poly[poly_ind].ch[ch].ph_el / self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].mult
                                }]
                            });
                            self.m_fitting_chart.options.data.push({
                                type: "error",
                                visible: self.m_current_channels[ch],
                                color: self.palette[ch],
                                showInLegend: false,
                                name: 'measured ' + (ch + 1),
                                dataPoints: [{
                                    x: self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].T,
                                    y: [
                                        (resp.poly[poly_ind].ch[ch].ph_el - resp.poly[poly_ind].ch[ch].err) /
                                        self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].mult,
                                        (resp.poly[poly_ind].ch[ch].ph_el + resp.poly[poly_ind].ch[ch].err) /
                                        self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].mult
                                    ]
                                }]
                            });
                        }
                    }
                    self.m_fitting_chart.options.axisX.minimum =
                        self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].T * 0;
                    self.m_fitting_chart.options.axisX.maximum =
                        self.m_currentShot.events[self.m_selected_event_ind].T_e[poly_ind].T * 2;
                    self.m_fitting_chart.render();

                }
            );
            self.m_raw_chart.options.data = [];
            self.m_current_event_raw = {};
            self.Request(
                {
                    reqtype: 'get_event_raw',
                    event: self.m_selected_event_ind,
                    is_plasma: $('#is_plasma')[0].checked,
                    shotn: $('#shot_select').val(),
                    poly: $('#poly_input').val(),
                    config: $('#config_select').val()
                }
                , function (resp) {
                    Object.assign(self.m_current_event_raw, resp);
                    //console.log(self.m_current_event_sig);
                    //console.log(self.m_currentShot);
                    let dt = 1 / parseFloat(self.m_currentShot.header.frequency)
                    self.m_raw_chart.options.axisX.minimum = - self.m_current_event_raw.start * dt;
                    self.m_raw_chart.options.axisX.maximum = (self.m_currentShot.header.eventLength -
                        self.m_current_event_raw.start) * dt;
                    for(let ch = 0; ch < self.m_current_event_raw.data.length; ch++){
                        let data = [];
                        for(let time_ind = 0; time_ind < self.m_currentShot.header.eventLength; time_ind++){
                            if(ch !== 5) {
                                data.push(
                                    {
                                        x: (time_ind - self.m_current_event_raw.start) * dt,
                                        y: self.m_current_event_raw.data[ch][time_ind] -
                                            self.m_current_event_sig.poly[poly_ind].ch[ch].zero_lvl
                                    });
                            }else{
                                data.push(
                                    {
                                        x: (time_ind - self.m_current_event_raw.start) * dt,
                                        y: self.m_current_event_raw.data[ch][time_ind]
                                    });
                            }
                        }
                        self.m_raw_chart.options.data.push({
                            type: "line",
                            color: self.palette[ch],
                            markerType: "none",
                            showInLegend: ch === 5,
                            name: 'ch ' + (ch + 1),
                            dataPoints: data,
                            ch_ind: ch,
                            visible: self.m_current_channels[ch]
                        });
                    }
                    let data = [];
                    for(let time_ind = 0; time_ind < self.m_currentShot.header.eventLength; time_ind++){
                        data.push(
                            {
                                x: (time_ind - self.m_current_event_raw.start) * dt,
                                y: self.m_current_event_raw.laser[time_ind]
                            });
                    }
                    self.m_raw_chart.options.data.push({
                        color: "#B0D0B0",
                        type: "line",
                        markerType: "none",
                        showInLegend: true,
                        name: 'laser',
                        dataPoints: data,
                        visible: self.m_current_channels[6]
                    });
                    self.m_raw_chart.render();
                }
            );
        }

        this.UpdateProfiles = function(ev){
            let self = ev.data;

            self.m_T_profile_chart.options.data = [];
            self.m_n_profile_chart.options.data = [];
            for(let event_ind = 0; event_ind < self.m_currentShot.events.length; event_ind++) {
                if(self.m_currentShot.events[event_ind].timestamp >= self.m_timestamp_chart.navigator.slider.minimum &&
                    self.m_currentShot.events[event_ind].timestamp <= self.m_timestamp_chart.navigator.slider.maximum){
                    self.m_T_profile_chart.options.data.push(self.m_T_profile_data[event_ind * 2]);
                    self.m_T_profile_chart.options.data.push(self.m_T_profile_data[event_ind * 2 + 1]);

                    self.m_n_profile_chart.options.data.push(self.m_n_profile_data[event_ind * 2]);
                    self.m_n_profile_chart.options.data.push(self.m_n_profile_data[event_ind * 2 + 1]);
                }
            }
            self.m_T_profile_chart.render();
            self.m_n_profile_chart.render();
        };

        this.ConnectControls = function (ev) {
            let self = ev.data;
            $('#shot_refresh').on('click', this, this.Refresh);
            $('#shot_select').on('change', this, this.Select);
            $('#is_plasma').on('change', this, this.UpdateShotSelect);
            $(document).keydown(function(event){
                if(!$('#draggable')[0].contains(document.activeElement)) {
                    self.KeydownMain(event);
                }else{
                    self.KeydownDraggable(event);
                }
            }.bind(self));

            dragElement($('#draggable')[0]);
            $('#hide_draggable').on('click', this, function (ev) {
                $('#draggable').attr('hidden', true);
            });

            $('#poly_input').on('change', this, this.draw_popup);
        };

        //can be optimised by disabling auto-render
        this.KeydownMain = function(event){
            let resized = false;
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                if (event.altKey) {
                    if (event.ctrlKey) {
                        console.log('fuck off');
                        return;
                    }
                    this.m_timestamp_chart.navigator.slider.set("maximum",
                        this.m_timestamp_chart.navigator.slider.get("maximum") - this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                } else if (event.ctrlKey) {
                    this.m_timestamp_chart.navigator.slider.set("minimum",
                        this.m_timestamp_chart.navigator.slider.get("minimum") - this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                } else {
                    this.m_timestamp_chart.navigator.slider.set("maximum",
                        this.m_timestamp_chart.navigator.slider.get("maximum") - this.m_keypress_timestep);
                    this.m_timestamp_chart.navigator.slider.set("minimum",
                        this.m_timestamp_chart.navigator.slider.get("minimum") - this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                }
            } else if (event.key === 'ArrowRight') {
                event.preventDefault();
                if (event.altKey) {
                    if (event.ctrlKey) {
                        console.log('fuck off');
                        return;
                    }
                    this.m_timestamp_chart.navigator.slider.set("maximum",
                        this.m_timestamp_chart.navigator.slider.get("maximum") + this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                } else if (event.ctrlKey) {
                    this.m_timestamp_chart.navigator.slider.set("minimum",
                        this.m_timestamp_chart.navigator.slider.get("minimum") + this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                } else {
                    this.m_timestamp_chart.navigator.slider.set("maximum",
                        this.m_timestamp_chart.navigator.slider.get("maximum") + this.m_keypress_timestep);
                    this.m_timestamp_chart.navigator.slider.set("minimum",
                        this.m_timestamp_chart.navigator.slider.get("minimum") + this.m_keypress_timestep);
                    this.RangeChanged({
                        minimum: this.m_timestamp_chart.navigator.slider.get("minimum"),
                        maximum: this.m_timestamp_chart.navigator.slider.get("maximum")
                    });
                    resized = true;
                }
            } else if (event.key === 'f') {
                event.preventDefault();
                if('labelBackgroundColor' in this.m_timestamp_chart.options.charts[0].axisY){
                    //console.log('release');
                    delete this.m_timestamp_chart.options.charts[0].axisY.maximum;
                    delete this.m_timestamp_chart.options.charts[0].axisY.labelBackgroundColor;
                    delete this.m_timestamp_chart.options.charts[0].axisY.labelFontColor;

                    delete this.m_T_evo_chart.options.axisY.maximum;
                    delete this.m_T_evo_chart.options.axisY.labelBackgroundColor;
                    delete this.m_T_evo_chart.options.axisY.labelFontColor;

                    delete this.m_n_evo_chart.options.axisY.maximum;
                    delete this.m_n_evo_chart.options.axisY.labelBackgroundColor;
                    delete this.m_n_evo_chart.options.axisY.labelFontColor;

                    delete this.m_T_profile_chart.options.axisY.maximum;
                    delete this.m_T_profile_chart.options.axisY.labelBackgroundColor;
                    delete this.m_T_profile_chart.options.axisY.labelFontColor;

                    delete this.m_n_profile_chart.options.axisY.maximum;
                    delete this.m_n_profile_chart.options.axisY.labelBackgroundColor;
                    delete this.m_n_profile_chart.options.axisY.labelFontColor;
                }else{
                    //console.log('fix');
                    this.m_timestamp_chart.options.charts[0].axisY.maximum = this.m_timestamp_chart.charts[0].axisY[0].viewportMaximum;
                    this.m_timestamp_chart.options.charts[0].axisY.labelBackgroundColor = "gray";
                    this.m_timestamp_chart.options.charts[0].axisY.labelFontColor = "white";

                    this.m_T_evo_chart.options.axisY.maximum = this.m_T_evo_chart.axisY[0].viewportMaximum;
                    this.m_T_evo_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_T_evo_chart.options.axisY.labelFontColor = "white";

                    this.m_n_evo_chart.options.axisY.maximum = this.m_n_evo_chart.axisY[0].viewportMaximum;
                    this.m_n_evo_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_n_evo_chart.options.axisY.labelFontColor = "white";

                    this.m_T_profile_chart.options.axisY.maximum = this.m_T_profile_chart.axisY[0].viewportMaximum;
                    this.m_T_profile_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_T_profile_chart.options.axisY.labelFontColor = "white";

                    this.m_n_profile_chart.options.axisY.maximum = this.m_n_profile_chart.axisY[0].viewportMaximum;
                    this.m_n_profile_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_n_profile_chart.options.axisY.labelFontColor = "white";
                }
                this.m_timestamp_chart.render();
                this.m_T_evo_chart.render();
                this.m_n_evo_chart.render();
                this.m_T_profile_chart.render();
                this.m_n_profile_chart.render();
            }
            if (resized) {
                this.m_T_evo_chart.toolTip.hide();
                this.m_n_evo_chart.toolTip.hide();
                this.m_timestamp_chart.charts[0].toolTip.hide();

                this.m_T_evo_chart.axisX[0].crosshair.hide();
                this.m_n_evo_chart.axisX[0].crosshair.hide();
                this.m_timestamp_chart.charts[0].axisX[0].crosshair.hide();
            }
        }.bind(this);

        this.KeydownDraggable = function(event){
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                this.m_selected_event_ind = Math.min(this.m_selected_event_ind + 1,
                    this.m_currentShot.events.length - 1);
                this.draw_popup({data: this});
            }else if (event.key === 'ArrowRight') {
                event.preventDefault();
                this.m_selected_event_ind = Math.max(0, this.m_selected_event_ind - 1);
                this.draw_popup({data: this});
            }else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if($('#poly_input').val() < $('#poly_input').attr('max')){
                    $('#poly_input')[0].stepUp();
                    this.draw_popup({data: this});
                }
            }else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if($('#poly_input').val() > $('#poly_input').attr('min')){
                    $('#poly_input')[0].stepDown();
                    this.draw_popup({data: this});
                }
            }else if (event.key === 'f') {
                event.preventDefault();
                if('labelBackgroundColor' in this.m_fitting_chart.options.charts[0].axisY){
                    //console.log('release');
                    delete this.m_fitting_chart.options.charts[0].axisY.maximum;
                    delete this.m_fitting_chart.options.charts[0].axisY.labelBackgroundColor;
                    delete this.m_fitting_chart.options.charts[0].axisY.labelFontColor;

                    delete this.m_raw_chart.options.axisY.maximum;
                    delete this.m_raw_chart.options.axisY.labelBackgroundColor;
                    delete this.m_raw_chart.options.axisY.labelFontColor;
                }else{
                    //console.log('fix');
                    this.m_fitting_chart.options.axisY.maximum = this.m_fitting_chart.axisY[0].viewportMaximum;
                    this.m_fitting_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_fitting_chart.options.axisY.labelFontColor = "white";

                    this.m_raw_chart.options.axisY.maximum = this.m_raw_chart.axisY[0].viewportMaximum;
                    this.m_raw_chart.options.axisY.labelBackgroundColor = "gray";
                    this.m_raw_chart.options.axisY.labelFontColor = "white";
                }
                this.m_fitting_chart.render();
                this.m_raw_chart.render();
            }
        }.bind(this);

        this.ConnectControls({data: this});
    }

    function dragElement(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        if ($('#' + elmnt.id + "header")[0]) {
            // if present, the header is where you move the DIV from:
            $('#' + elmnt.id + "header")[0].onmousedown = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
        }
        elmnt.style.top = 10 + '%';
        elmnt.style.left = 70 + '%'

        function dragMouseDown(e) {
            //console.log(e);
            //e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            //e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    $(document).ready(
        function () {
            let viewer = new Main();
            viewer.Refresh({data: viewer});
        }
    )
</script>
</html>