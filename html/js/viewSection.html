<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View section</title>
</head>
<style>
    .canvasjs-chart-tooltip{
        pointer-events: auto !important;
    }
</style>
<body>
    <div class="row" id="db_row" style="
        margin-left: 0;
        margin-right: 0;
        ">
        <label for="is_plasma">Is plasma?</label>
            <input type="checkbox" id="is_plasma" checked>
        <label for="shot_select">Choose a shot:</label>
        <select id="shot_select"></select>
        <button class="btn btn-success glyphicon glyphicon-refresh" id="shot_refresh">Refresh</button>
        <label for="auto_load">Load last shot automatically?</label>
            <input type="checkbox" id="auto_load" checked>
    </div>

    <hr>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                <div id="timestamp_chart" style="width:100%; height:200px;"></div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <div id="radius_chart" style="width:100%; height:200px;"></div>
            </div>
        </div>
    </div>
    <hr>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                <div id="T_evo_chart" style="width:100%; height:500px;"></div>
                <div id="n_evo_chart" style="width:100%; height:500px;"></div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <div id="T_profile_chart" style="width:100%; height:200px;"></div>
            </div>
        </div>
    </div>

    <div id="profile_chart" style="width:100%; height:600px;"></div>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Active</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
            <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
    </ul>
    <div class="row" id="view_tabs_wrong" style="
        margin-left: 0;
        margin-right: 0;
        ">
        <label for="board_spinbox">Board №</label><input type="number" min="0" value="0" max="3" id="board_spinbox">
        <label for="event_spinbox">Event №</label><input type="number" min="0" max="0" value="0" id="event_spinbox">
        <div class="row" id="events" style="
        margin-left: 0;
        margin-right: 0;
        ">

        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1" id="event_prefix">
                0ms
            </div>
            <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                <input type="range" min="0" max="0" value="0" id="event_range">
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1" id="event_suffix">

            </div>
        </div>
    </div>
    <div id="chartContainer" style="width:100%; height:400px;"></div>
    <div id="slider-range"></div>
</body>
<script>
    function Main () {
        this.m_currentShot = {};
        this.m_currentEvent = {};

        this.m_chart = new CanvasJS.Chart("chartContainer", {
            title: {
                text: "Raw ADC data"
            },
            axisY: {
                title: "Voltage, mV",
                includeZero: true,
                minimum: -150,
                maximum: 2350
            },
            axisX: {
                title: "Local time, ns",
            },
            data: []
        });

        this.m_timestamp_chart = new CanvasJS.StockChart("timestamp_chart",{
            theme: "light2",
            charts: [{
                title: {
                    text: "Shot timeline"
                },
                axisY: {
                    includeZero: true,
                    title: "Energy, mV*ns"
                },
                axisX: {
                    title: "Timestamp, ms",
                },
                data: []
            }],
            navigator: {
                slider: {
                    minimum: 100,
                    maximum: 250,
                    height: 100
                }
            },
            rangeChanged: function(e) {
                this.m_T_evo_chart.options.axisX.minimum = e.minimum;
                this.m_T_evo_chart.options.axisX.maximum = e.maximum;
                this.m_T_evo_chart.render();
                this.m_n_evo_chart.options.axisX.minimum = e.minimum;
                this.m_n_evo_chart.options.axisX.maximum = e.maximum;
                this.m_n_evo_chart.render();
            }.bind(this),
        });


        this.m_radius_chart = new CanvasJS.Chart("radius_chart", {
            title: {
                text: "Spatial points"
            },
            axisY: {
                title: "Z, cm",
                includeZero: true,
                minimum: -10,
                maximum: 10
            },
            axisX: {
                title: "R, mm",
            },
            data: []
        });

        this.m_T_evo_chart = new CanvasJS.Chart("T_evo_chart", {
            title: {
                text: 'Electron temperature evolution',
                fontSize: 14
            },
            axisY: {
                includeZero: true,
                title: 'Electron temperature, eV',
                minimum: 0
            },
            axisX: {
                title: "Time, ms",
                minimum: 100,
                maximum: 250
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    //console.log(e);
                    return ( 'time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms ' +
                        e.entries[0].dataPoint.y.toFixed(1)) + 'eV';
                },
            },
            data: []
        });

        this.m_n_evo_chart = new CanvasJS.Chart("n_evo_chart", {
            title: {
                text: 'Electron density evolution',
                fontSize: 14
            },
            axisY: {
                includeZero: true,
                title: 'Electron density, m^-3',
                labelFormatter: function ( e ) {
                    return e.value.toExponential(1);
                },
                minimum: 0
            },
            axisX: {
                title: "Time, ms",
                minimum: 100,
                maximum: 250
            },
            toolTip: {
                shared: true,
                contentFormatter: function(e){
                    //console.log(e);
                    return ( 'time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms ' +
                        e.entries[0].dataPoint.y.toExponential(1)) + 'm^-3';
                },
            },
            data: []
        });

        this.m_profile_chart = new CanvasJS.Chart("profile_chart", {
            title: {
                text: "Signal profile"
            },
            axisY: {
                title: "Signal, ph.el.",
                includeZero: true,
                minimum: 0
            },
            axisX: {
                title: "R, mm",
            },
            data: []
        });

        //this.m_timestamp_chart.render();
        this.m_radius_chart.render();

        this.m_T_evo_chart.render();
        this.m_n_evo_chart.render();

        this.m_profile_chart.render();

        this.Request = function (req, callback) {
            req.subsystem = 'view';
            $.post('/api', JSON.stringify(req), function(resp){
                if(!resp['ok']){
                    console.log(resp);
                    alert(resp['description']);
                }else {
                    callback(resp);
                }
            }, 'json');
        };


        this.Refresh = function(ev) {
            let self = ev.data;
            self.Request(
                {
                    reqtype: 'refresh'
                }
                , function (resp) {
                    self.m_plasma_shots = resp['plasma'];
                    self.m_debug_shots = resp['debug'];
                    self.UpdateShotSelect({data: self});
                }
            );
        };

        this.UpdateShotSelect = function(ev) {
            let self = ev.data;
            let shots = self.m_plasma_shots;
            console.log('plasma_shots')
            if(! $('#is_plasma')[0].checked){
                shots = self.m_debug_shots;
                console.log('debug_shots')
            }
            let options = []
            shots.forEach(shot => options.push("<option>" + shot + "</option>"));
            $('#shot_select').html(options);
            if(options.length && $('#auto_load')[0].checked){
                self.Select({data: self})
            }
        };

        this.Select = function(ev){
            let self = ev.data;
            $('#event_range')[0].max = 0
            $('#event_spinbox')[0].max = 0
            self.Request(
                {
                    reqtype: 'get_shot',
                    is_plasma: $('#is_plasma')[0].checked,
                    shotn: $('#shot_select').val()
                }, function (resp) {
                    //console.log(resp);
                    Object.assign(self.m_currentShot, resp);
                    self.m_timestamp_chart.options.charts[0].data = [{
                        color: "#B0D0B0",
                        type: "column",
                        showInLegend: false,
                        name: 'Laser energy',
                        dataPoints: [],
                        click: function (e) {
                            self.m_profile_chart.render();
                            self.Request(
                                {
                                    reqtype: 'get_event_sig',
                                    event: e.dataPointIndex
                                }
                                , function (resp) {
                                    //console.log(resp);
                                    resp['event_ind'] = e.dataPointIndex;
                                    resp['timestamp'] = e.dataPoint.x;
                                    Object.assign(self.m_currentEvent, resp);
                                    self.UpdateProfile({data: self});
                                }
                            );
                        }
                    }];

                    self.m_T_evo_chart.options.data = []
                    self.m_n_evo_chart.options.data = []
                    self.m_radius_chart.options.data = []
                    for(let poly_ind = 0; poly_ind < resp.polys.length; poly_ind++){
                        self.m_radius_chart.options.data.push(
                            {
                                //color: "#B0D0B0",
                                type: "rangeArea",
                                showInLegend: true,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                dataPoints: [{
                                    x: resp.polys[poly_ind].R - 5,
                                    y: [-5, 5]
                                },
                                    {
                                        x: resp.polys[poly_ind].R + 5,
                                        y: [-5, 5]
                                    }]
                            }
                        );

                        self.m_T_evo_chart.options.data.push(
                            {
                                //color: "#B0D0B0",
                                type: "line",
                                showInLegend: true,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                connectNullData: true,
                                nullDataLineDashType:  "dot",
                                dataPoints: [],
                                click: function (e) {
                                    console.log(e);
                                }
                            }
                        );
                        self.m_T_evo_chart.options.data.push(
                            {
                                //color: "#B0D0B0",
                                type: "error",
                                showInLegend: false,
                                dataPoints: []
                            }
                        );

                        self.m_n_evo_chart.options.data.push(
                            {
                                //color: "#B0D0B0",
                                type: "line",
                                showInLegend: false,
                                name: 'R = ' + resp.polys[poly_ind].R,
                                connectNullData: true,
                                nullDataLineDashType:  "dot",
                                dataPoints: [],
                                click: function (e) {
                                    console.log(e);
                                }
                            }
                        );
                        self.m_n_evo_chart.options.data.push(
                            {
                                //color: "#B0D0B0",
                                type: "error",
                                showInLegend: false,
                                dataPoints: []
                            }
                        );
                    }
                    self.m_radius_chart.render();

                    console.log(resp);
                    for(let event_ind = 0; event_ind < resp.events.length; event_ind++){
                        if(resp.events[event_ind].processed_bad){
                            self.m_timestamp_chart.options.charts[0].data[0].dataPoints.push(
                                {
                                    x: resp.events[event_ind].timestamp,
                                    y: null
                                }
                            );
                        }else {
                            self.m_timestamp_chart.options.charts[0].data[0].dataPoints.push(
                                {
                                    x: resp.events[event_ind].timestamp,
                                    y: resp.events[event_ind].energy
                                }
                            );
                        }
                        for(let poly_ind = 0; poly_ind < resp.polys.length; poly_ind++) {
                            if(resp.events[event_ind].T_e[poly_ind].processed_bad){
                                self.m_T_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: null
                                    }
                                );
                                self.m_n_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: null
                                    }
                                );
                            }else {
                                self.m_T_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: resp.events[event_ind].T_e[poly_ind].T
                                    }
                                );
                                self.m_T_evo_chart.options.data[poly_ind * 2 + 1].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: [resp.events[event_ind].T_e[poly_ind].T - resp.events[event_ind].T_e[poly_ind].Terr,
                                            resp.events[event_ind].T_e[poly_ind].T + resp.events[event_ind].T_e[poly_ind].Terr]
                                    }
                                );
                                self.m_n_evo_chart.options.data[poly_ind * 2].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: resp.events[event_ind].T_e[poly_ind].n
                                    }
                                );
                                self.m_n_evo_chart.options.data[poly_ind * 2 + 1].dataPoints.push(
                                    {
                                        x: resp.events[event_ind].timestamp,
                                        y: [resp.events[event_ind].T_e[poly_ind].n - resp.events[event_ind].T_e[poly_ind].n_err,
                                            resp.events[event_ind].T_e[poly_ind].n + resp.events[event_ind].T_e[poly_ind].n_err]
                                    }
                                );
                            }
                        }
                    }
                    self.m_timestamp_chart.render();
                    self.m_T_evo_chart.render();
                    self.m_n_evo_chart.render();


                    //self.ChangeBoard({data: self});
                    //self.GetEvent({data: self});
                }
            );
        };

        this.UpdateProfile = function(ev){
            let self = ev.data;
            //console.log(self.m_currentEvent);
            //console.log(self.m_currentShot);
            self.m_profile_chart.options.data = [];
            self.m_profile_chart.title = {
                text: self.m_currentEvent.timestamp.toFixed(1) + ' ms, event № ' + self.m_currentEvent.event_ind
            };
            for(let ch_ind = 0; ch_ind < 5; ch_ind++){
                let profile = []
                let errors = []
                for(let poly_ind = 0; poly_ind < 10; poly_ind++){
                    profile.push({
                        x: self.m_currentShot.polys[poly_ind].R,
                        y: self.m_currentEvent.poly[poly_ind].ch[ch_ind].ph_el
                    });
                    errors.push({
                        x: self.m_currentShot.polys[poly_ind].R,
                        y: [
                            self.m_currentEvent.poly[poly_ind].ch[ch_ind].ph_el -
                            self.m_currentEvent.poly[poly_ind].ch[ch_ind].err,
                            self.m_currentEvent.poly[poly_ind].ch[ch_ind].ph_el +
                            self.m_currentEvent.poly[poly_ind].ch[ch_ind].err
                        ]
                    });
                }
                self.m_profile_chart.options.data.push({
                    type: "spline",
                    showInLegend: true,
                    name: 'ch ' + (ch_ind + 1),
                    toolTipContent: 'spectral channel ' + (ch_ind + 1) + ', {x} mm: {y} ph.el',
                    dataPoints: profile
                });
                self.m_profile_chart.options.data.push({
                    type: "error",
                    showInLegend: false,
                    name: 'Error',
                    dataPoints: errors
                });
            }

            self.m_profile_chart.render();
            console.log('Rendered?');
        };

        this.ChangeBoard = function(ev){
            let self = ev.data;
            $('#event_range')[0].max = self.m_currentShot['boards'][$('#board_spinbox').val()].length;
            $('#event_spinbox')[0].max = self.m_currentShot['boards'][$('#board_spinbox').val()].length;
            $('#event_suffix').text(self.m_currentShot['boards'][$('#board_spinbox').val()][self.m_currentShot['boards'][$('#board_spinbox').val()].length - 1].toFixed(2) + 'ms');
        }

        this.UpdateEventSpinbox = function(ev){
            let self = ev.data;
            if($('#event_range').val() != $('#event_spinbox').val()){
                $('#event_spinbox').val($('#event_range').val());
                self.GetEvent({data: self});
            }
        }

        this.UpdateEventRange = function(ev){
            let self = ev.data;
            if($('#event_range').val() != $('#event_spinbox').val()){
                $('#event_range').val($('#event_spinbox').val());
                self.GetEvent({data: self});
            }
        }

        this.GetEvent = function(ev){
            let self = ev.data;
            self.m_chartData = [];
            self.m_chart.render();
            self.Request(
                {
                    reqtype: 'get_event',
                    is_plasma: $('#is_plasma')[0].checked,
                    shotn: $('#shot_select').val(),
                    board: parseInt($('#board_spinbox').val()),
                    event: parseInt($('#event_spinbox').val())
                }
                , function (resp) {
                    //console.log(resp);
                    
                    Object.assign(self.m_currentEvent, resp);
                    self.UpdateChart({data: self});
                }
            );
        };

        this.UpdateChart = function(ev){
            let self = ev.data;
            self.m_chartData = []
            //console.log(self.m_currentEvent);
            if(Object.keys(self.m_currentEvent).length !== 0){
                for(let group = 0; group < 8; group++){
                    for(let gr_ch = 0; gr_ch < 2; gr_ch++){
                        let ch = gr_ch + group * 2;
                        let data_points = [];
                        for(let cell = 0; cell < 1024; cell++){
                            data_points.push({
                                x: cell*0.3125,
                                y: self.m_currentEvent.event.groups[group].data[gr_ch][cell]
                            })
                        }
                        self.m_chartData.push(
                            {
                                type: "spline",
                                showInLegend: true,
                                name: 'ch ' + ch,
                                toolTipContent: 'ch ' + ch + ', {x} ns: {y} mV',
                                dataPoints: data_points
                        });
                    }
                }
                //console.log(self.m_chartData)
            }

            self.m_chart.options.data = self.m_chartData;
            self.m_chart.render();
            console.log('Rendered?');
        };

        this.ConnectControls = function () {
            $('#shot_refresh').on('click', this, this.Refresh);
            $('#shot_select').on('change', this, this.Select);
            $('#is_plasma').on('change', this, this.UpdateShotSelect);
            $('#board_spinbox').on('change', this, this.ChangeBoard)
            $('#event_range').on('change', this, this.UpdateEventSpinbox);
            $('#event_spinbox').on('change', this, this.UpdateEventRange);
        };

        this.ConnectControls();
        this.UpdateChart({data: this});
    }

    $(document).ready(
        function () {
            let viewer = new Main();
            viewer.Refresh({data: viewer});
        }
    )
</script>
</html>