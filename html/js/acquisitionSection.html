<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Acquisition Section</title>
</head>
<body>
    <div class="row">
        <p>ADC control</p>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <p id="ADC_state">No connection</p>
            <button class="btn btn-info" id="ADC_refresh_button">Refresh</button>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <label for="next_shot_number">Next shot №:</label><output id="next_shot_number"></output>
            <label for="is_plasma">Is plasma?</label><input type="checkbox" id="is_plasma" checked>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <button class="btn btn-success" id="ADC_arm_button">Arm</button>
            <button class="btn btn-danger" id="ADC_disarm_button">Disarm</button>
        </div>
    </div>
    <hr>
    <div id="laser_row">
        <p>Laser control</p>
        <div class="row">
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <p id="laser_state">No connection</p>
                <button class="btn btn-info" id="laser_reconnect_button">Reconnect</button>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <p id="laser_sync">internal</p>
                <p id="laser_remote">Local control</p>
                <p id="laser_enable">Disabled</p>
                <p id="laser_wait5v">Wait 5V</p>
                <p id="laser_5v">5V</p>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <button class="btn btn-success" id="laser_fire_button">Fire</button>
                <button class="btn btn-danger" id="laser_idle_button">Idle</button>
            </div>
        </div>
        <img alt="No connection to camera!" style="-webkit-user-select: none; margin: auto;"
             src="http://192.168.10.46/action/stream?subject=mjpeg" width="500px" height="500px">
    </div>
</body>
<script>
    function Main () {
        this.m_laser_warm = null;
        this.m_laser_warming = null;

        this.RequestADC = function (req, callback) {
            req.subsystem = 'adc';
            $.post('/api', JSON.stringify(req), callback, 'json');
        };

        this.ADCRefresh = function(ev){
            let state = $('#ADC_state');
            state.css('background-color','grey');
            state.html('Requesting...');
            this.RequestADC(
                {
                    reqtype: 'status'
                }
                , function (resp) {
                    console.log(resp);
                    if(resp.ok){
                        state.css('background-color','green');
                        state.html('Connected');
                        $('#next_shot_number').val(resp.shotn);
                    }else{
                        state.css('background-color','red');
                        state.html('No connection');
                    }
                }
            );
        }.bind(this);

        this.ADCArm = function(ev) {
            let req = {
                reqtype: 'arm',
                isPlasma: $('#is_plasma')[0].checked
            }
            this.RequestADC(
                req, function (resp) {
                    if(resp.ok){
                        state.css('background-color','yellow');
                        state.html('Armed');
                        alert(resp.shotn);
                    }else{
                        state.css('background-color','red');
                        state.html('No connection');
                        console.log(resp);
                        alert(resp.description);
                    }
                }
            );
        }.bind(this);

        this.ADCDisarm = function(ev){
            let req = {
                reqtype: 'disarm'
            }
            this.RequestADC(
                req, function (resp) {
                    if(resp.ok){
                        state.css('background-color','green');
                        state.html('Disarmed');
                        alert(resp.shotn);
                    }else{
                        state.css('background-color','red');
                        state.html('No connection');
                        console.log(resp);
                        alert(resp.description);
                    }
                }
            );
        }.bind(this);

        this.RequestLas = function (req, callback) {
            req.subsystem = 'laser';
            $.post('/api', JSON.stringify(req), callback, 'json');
        };

        this.LasConnect = function(ev){
            this.RequestLas(
                {
                    reqtype: 'connect'
                }
                , function (resp) {
                    if(resp.ok) {
                        setInterval(this.LasStatus, 500);
                    }else{
                        alert(resp);
                    }
                }.bind(this)
            );
        }.bind(this);

        this.LasStatus = function(ev){
            let state = $('#laser_state');
            state.css('background-color','grey');
            state.html('Requesting...');
            this.RequestLas(
                {
                    reqtype: 'status'
                }
                , function (resp) {
                    if(resp.ok){
                        if(resp.state[7]){
                            alert('Аварийная остановка лазера!');
                            state.css('background-color','red');
                            state.html(resp.description);
                        }else if(!resp.state[0]){
                            state.css('background-color','blue');
                            state.html('Power off.');
                            this.m_laser_warm = null;
                            this.m_laser_warming = null;
                        }else if(!resp.state[1]){
                            state.css('background-color','white');
                            state.html('Idle.');
                            this.m_laser_warm = null;
                            this.m_laser_warming = null;
                        }else if(!resp.state[6]){
                            if(this.m_laser_warm){
                                state.css('background-color', 'green');
                                state.html('Ready. ' + (60 - (Date.now() - this.m_laser_warm)/1000).toFixed(0) + 's left.');
                            }else {
                                let time_left = 15 - (Date.now() - this.m_laser_warming)/1000;
                                if(time_left <= 0){
                                    this.m_laser_warm = Date.now();
                                }
                                state.css('background-color', 'yellow');
                                state.html('Warming up... ' + time_left.toFixed(0) + 's left.');
                            }
                        }else{
                            state.css('background-color','red');
                            state.html('Firing! ' + (60 - (Date.now() - this.m_laser_warm)/1000).toFixed(0) + 's left.');
                        }
                        let sync = $('#laser_sync')
                        if(resp.state[2]){
                            sync.css('background-color','white');
                            sync.html('External.');
                        }else{
                            sync.css('background-color','yellow');
                            sync.html('Internal.');
                        }
                        let remote = $('#laser_remote')
                        if(resp.state[14]){
                            remote.css('background-color','white');
                            remote.html('External.');
                        }else{
                            remote.css('background-color','yellow');
                            remote.html('Internal.');
                        }
                        let enable = $('#laser_enable')
                        if(resp.state[15]){
                            enable.css('background-color','white');
                            enable.html('Enabled.');
                        }else{
                            enable.css('background-color','yellow');
                            enable.html('Disabled.');
                        }
                        let wait5v = $('#laser_wait5v')
                        if(resp.state[13]){
                            wait5v.css('background-color','yellow');
                            wait5v.html('Ignore 5V.');
                        }else{
                            wait5v.css('background-color','white');
                            wait5v.html('Wait 5V.');
                        }
                        let signal5v = $('#laser_5v')
                        if(resp.state[12]){
                            signal5v.css('background-color','green');
                            signal5v.html('5V.');
                        }else{
                            signal5v.css('background-color','white');
                            signal5v.html('No signal');
                        }
                    }else{
                        console.log(resp);
                        state.css('background-color','red');
                        state.html(resp.description);
                    }
                }.bind(this)
            );
        }.bind(this);

        this.LasFire = function(ev){
            let state = $('#laser_state');
            state.css('background-color','grey');
            state.html('Requesting...');
            this.RequestLas(
                {
                    reqtype: 'fire'
                }
                , function (resp) {
                    if(resp.ok){
                        this.m_laser_warming = Date.now();
                    }else{
                        console.log(resp);
                        state.css('background-color','red');
                        state.html(resp.description);
                    }
                }.bind(this)
            );
        }.bind(this);

        this.LasIdle = function(ev){
            let state = $('#laser_state');
            state.css('background-color','grey');
            state.html('Requesting...');
            this.RequestLas(
                {
                    reqtype: 'idle'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        state.css('background-color','red');
                        state.html(resp.description);
                        alert('Failed to turn off laser!');
                    }else{
                        this.m_laser_warming = null;
                        this.m_laser_warm = null;
                    }
                }.bind(this)
            );
        }.bind(this);

        this.ConnectControls = function () {
            $('#ADC_refresh_button').on('click', this, this.ADCRefresh);
            $('#ADC_arm_button').on('click', this, this.ADCArm);
            $('#ADC_disarm_button').on('click', this, this.ADCDisarm);

            $('#laser_reconnect_button').on('click', this, this.LasConnect);
            $('#laser_fire_button').on('click', this, this.LasFire);
            $('#laser_idle_button').on('click', this, this.LasIdle);
        };

        this.ConnectControls();
        //this.ADCRefresh(null);
        this.LasConnect(null);

    }

    $(document).ready(
        function () {
            let viewer = new Main();
        }
    )
</script>
</html>